{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/daichi/insane/workspace/playground/v0-mahjong-score-tracker/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\"\n\nlet adminClient: ReturnType<typeof createClient> | null = null\n\nexport function createAdminClient() {\n  if (adminClient) {\n    return adminClient\n  }\n\n  if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    throw new Error(\"SUPABASE_SERVICE_ROLE_KEY is not set\")\n  }\n\n  adminClient = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY, {\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  })\n\n  return adminClient\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,cAAsD;AAEnD,SAAS;IACd,IAAI,aAAa;QACf,OAAO;IACT;IAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;QAC1C,MAAM,IAAI,MAAM;IAClB;IAEA,cAAc,IAAA,oVAAY,gFAAwC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;QACvG,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;QACpB;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/daichi/insane/workspace/playground/v0-mahjong-score-tracker/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Server Component context - ignore\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,wXAAO;IAEjC,OAAO,IAAA,wXAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,oCAAoC;gBACtC;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 102, "column": 0}, "map": {"version":3,"sources":["file:///Users/daichi/insane/workspace/playground/v0-mahjong-score-tracker/app/api/account-delete/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { createAdminClient } from \"@/lib/supabase/admin\"\nimport { createClient as createServerClient } from \"@/lib/supabase/server\"\n\nfunction uniqueIds(ids: Array<string | null | undefined>) {\n  return Array.from(new Set(ids.filter((id): id is string => Boolean(id))))\n}\n\nexport async function POST() {\n  try {\n    const supabase = await createServerClient()\n    const {\n      data: { user },\n      error,\n    } = await supabase.auth.getUser()\n\n    if (error || !user) {\n      return NextResponse.json({ error: \"ログインが必要です\" }, { status: 401 })\n    }\n\n    const admin = createAdminClient()\n\n    const { data: ownedLeagues, error: ownedLeaguesError } = await admin\n      .from(\"leagues\")\n      .select(\"id\")\n      .eq(\"owner_id\", user.id)\n\n    if (ownedLeaguesError) {\n      return NextResponse.json({ error: \"リーグ情報の取得に失敗しました\" }, { status: 500 })\n    }\n\n    const leagueIds = uniqueIds(ownedLeagues?.map((l) => l.id) ?? [])\n\n    const { data: gamesByOwner, error: gamesByOwnerError } = await admin\n      .from(\"games\")\n      .select(\"id\")\n      .eq(\"created_by\", user.id)\n\n    if (gamesByOwnerError) {\n      return NextResponse.json({ error: \"対局情報の取得に失敗しました\" }, { status: 500 })\n    }\n\n    let gamesByLeague: Array<{ id: string }> = []\n    if (leagueIds.length > 0) {\n      const { data, error: gamesByLeagueError } = await admin\n        .from(\"games\")\n        .select(\"id\")\n        .in(\"league_id\", leagueIds)\n      if (gamesByLeagueError) {\n        return NextResponse.json({ error: \"対局情報の取得に失敗しました\" }, { status: 500 })\n      }\n      gamesByLeague = data || []\n    }\n\n    const gameIds = uniqueIds([\n      ...(gamesByOwner?.map((g) => g.id) ?? []),\n      ...(gamesByLeague?.map((g) => g.id) ?? []),\n    ])\n\n    if (gameIds.length > 0) {\n      const { error: deleteGameResultsError } = await admin.from(\"game_results\").delete().in(\"game_id\", gameIds)\n      if (deleteGameResultsError) {\n        return NextResponse.json({ error: \"対局結果の削除に失敗しました\" }, { status: 500 })\n      }\n    }\n\n    const { error: anonymizeError } = await admin\n      .from(\"game_results\")\n      .update({ user_id: null, player_name: \"退会ユーザー\" })\n      .eq(\"user_id\", user.id)\n\n    if (anonymizeError) {\n      return NextResponse.json({ error: \"対局結果の更新に失敗しました\" }, { status: 500 })\n    }\n\n    if (gameIds.length > 0) {\n      const { error: deleteGamesError } = await admin.from(\"games\").delete().in(\"id\", gameIds)\n      if (deleteGamesError) {\n        return NextResponse.json({ error: \"対局の削除に失敗しました\" }, { status: 500 })\n      }\n    }\n\n    if (leagueIds.length > 0) {\n      const { error: deleteLeagueMembersError } = await admin.from(\"league_members\").delete().in(\"league_id\", leagueIds)\n      if (deleteLeagueMembersError) {\n        return NextResponse.json({ error: \"リーグ参加情報の削除に失敗しました\" }, { status: 500 })\n      }\n    }\n\n    const { error: deleteMyMembershipsError } = await admin\n      .from(\"league_members\")\n      .delete()\n      .eq(\"user_id\", user.id)\n    if (deleteMyMembershipsError) {\n      return NextResponse.json({ error: \"リーグ参加情報の削除に失敗しました\" }, { status: 500 })\n    }\n\n    if (leagueIds.length > 0) {\n      const { error: deleteLeaguesError } = await admin.from(\"leagues\").delete().in(\"id\", leagueIds)\n      if (deleteLeaguesError) {\n        return NextResponse.json({ error: \"リーグの削除に失敗しました\" }, { status: 500 })\n      }\n    }\n\n    const { error: deleteFriendshipsError } = await admin\n      .from(\"friendships\")\n      .delete()\n      .or(`requester_id.eq.${user.id},addressee_id.eq.${user.id}`)\n    if (deleteFriendshipsError) {\n      return NextResponse.json({ error: \"フレンド情報の削除に失敗しました\" }, { status: 500 })\n    }\n\n    const { error: deleteRulesError } = await admin.from(\"rules\").delete().eq(\"created_by\", user.id)\n    if (deleteRulesError) {\n      return NextResponse.json({ error: \"ルールの削除に失敗しました\" }, { status: 500 })\n    }\n\n    const { error: deleteProfileError } = await admin.from(\"profiles\").delete().eq(\"id\", user.id)\n    if (deleteProfileError) {\n      return NextResponse.json({ error: \"プロフィールの削除に失敗しました\" }, { status: 500 })\n    }\n\n    const { error: deleteUserError } = await admin.auth.admin.deleteUser(user.id)\n    if (deleteUserError) {\n      return NextResponse.json({ error: \"アカウントの削除に失敗しました\" }, { status: 500 })\n    }\n\n    return NextResponse.json({ message: \"アカウントを削除しました\" })\n  } catch (error) {\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"アカウントの削除に失敗しました\" },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}