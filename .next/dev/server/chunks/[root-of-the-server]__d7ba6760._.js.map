{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/daichi/insane/workspace/playground/v0-mahjong-score-tracker/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\"\n\nlet adminClient: ReturnType<typeof createClient> | null = null\n\nexport function createAdminClient() {\n  if (adminClient) {\n    return adminClient\n  }\n\n  if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    throw new Error(\"SUPABASE_SERVICE_ROLE_KEY is not set\")\n  }\n\n  adminClient = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY, {\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  })\n\n  return adminClient\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,cAAsD;AAEnD,SAAS;IACd,IAAI,aAAa;QACf,OAAO;IACT;IAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;QAC1C,MAAM,IAAI,MAAM;IAClB;IAEA,cAAc,IAAA,oVAAY,gFAAwC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;QACvG,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;QACpB;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/daichi/insane/workspace/playground/v0-mahjong-score-tracker/app/api/friend-invite/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { createAdminClient } from \"@/lib/supabase/admin\"\n\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i\n\nfunction resolveBaseUrl(req: Request) {\n  return (\n    req.headers.get(\"origin\") ||\n    process.env.NEXT_PUBLIC_SITE_URL ||\n    process.env.NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL ||\n    \"http://localhost:3000\"\n  )\n}\n\ntype AdminUser = {\n  id: string\n  email: string | null\n  email_confirmed_at: string | null\n  deleted_at?: string | null\n}\n\nasync function findAuthUserByEmail(adminClient: ReturnType<typeof createAdminClient>, email: string) {\n  const normalizedEmail = email.toLowerCase()\n  const perPage = 200\n  let page = 1\n\n  while (page <= 20) {\n    const { data, error } = await adminClient.auth.admin.listUsers({ page, perPage })\n    if (error) {\n      throw new Error(\"ユーザー情報の取得に失敗しました\")\n    }\n\n    const match = data?.users?.find((user: AdminUser) => user.email?.toLowerCase() === normalizedEmail)\n    if (match) {\n      return match\n    }\n\n    if (!data?.users || data.users.length < perPage) {\n      break\n    }\n\n    page += 1\n  }\n\n  return null\n}\n\nexport async function POST(req: Request) {\n  try {\n    const { email, inviterId } = await req.json()\n\n    if (!email || typeof email !== \"string\") {\n      return NextResponse.json({ error: \"メールアドレスを入力してください\" }, { status: 400 })\n    }\n\n    if (!inviterId || typeof inviterId !== \"string\" || !uuidRegex.test(inviterId)) {\n      return NextResponse.json({ error: \"不正な招待情報です\" }, { status: 400 })\n    }\n\n    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\n      return NextResponse.json({ error: \"サーバー設定が不足しています\" }, { status: 500 })\n    }\n\n    const normalizedEmail = email.trim().toLowerCase()\n    const adminClient = createAdminClient()\n    const fetchedUser = await findAuthUserByEmail(adminClient, normalizedEmail)\n    const existingUser = fetchedUser && fetchedUser.deleted_at ? null : fetchedUser\n\n    if (existingUser) {\n      if (!existingUser.email_confirmed_at) {\n        const { error: deleteError } = await adminClient.auth.admin.deleteUser(existingUser.id)\n        if (deleteError) {\n          return NextResponse.json(\n            { error: \"未完了のアカウントをリセットできませんでした。時間を置いて再度お試しください。\" },\n            { status: 500 },\n          )\n        }\n      } else {\n        return NextResponse.json({ error: \"このメールアドレスは既に登録済みです\" }, { status: 400 })\n      }\n    }\n\n    const baseUrl = resolveBaseUrl(req).replace(/\\/$/, \"\")\n    const redirectTo = `${baseUrl}/auth/invite-complete`\n\n    const { error } = await adminClient.auth.admin.inviteUserByEmail(normalizedEmail, {\n      redirectTo,\n      data: {\n        inviter_id: inviterId,\n        needs_password: true,\n      },\n    })\n\n    if (error) {\n      return NextResponse.json({ error: error.message }, { status: 400 })\n    }\n\n    return NextResponse.json({ message: \"招待メールを送信しました\" })\n  } catch (error) {\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"招待メールの送信に失敗しました\" },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,YAAY;AAElB,SAAS,eAAe,GAAY;IAClC,OACE,IAAI,OAAO,CAAC,GAAG,CAAC,aAChB,QAAQ,GAAG,CAAC,oBAAoB,iGAEhC;AAEJ;AASA,eAAe,oBAAoB,WAAiD,EAAE,KAAa;IACjG,MAAM,kBAAkB,MAAM,WAAW;IACzC,MAAM,UAAU;IAChB,IAAI,OAAO;IAEX,MAAO,QAAQ,GAAI;QACjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,YAAY,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC;YAAE;YAAM;QAAQ;QAC/E,IAAI,OAAO;YACT,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,QAAQ,MAAM,OAAO,KAAK,CAAC,OAAoB,KAAK,KAAK,EAAE,kBAAkB;QACnF,IAAI,OAAO;YACT,OAAO;QACT;QAEA,IAAI,CAAC,MAAM,SAAS,KAAK,KAAK,CAAC,MAAM,GAAG,SAAS;YAC/C;QACF;QAEA,QAAQ;IACV;IAEA,OAAO;AACT;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,GAAG,MAAM,IAAI,IAAI;QAE3C,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,0VAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,IAAI,CAAC,aAAa,OAAO,cAAc,YAAY,CAAC,UAAU,IAAI,CAAC,YAAY;YAC7E,OAAO,0VAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACjE;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;YAC1C,OAAO,0VAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,kBAAkB,MAAM,IAAI,GAAG,WAAW;QAChD,MAAM,cAAc,IAAA,yNAAiB;QACrC,MAAM,cAAc,MAAM,oBAAoB,aAAa;QAC3D,MAAM,eAAe,eAAe,YAAY,UAAU,GAAG,OAAO;QAEpE,IAAI,cAAc;YAChB,IAAI,CAAC,aAAa,kBAAkB,EAAE;gBACpC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,YAAY,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,aAAa,EAAE;gBACtF,IAAI,aAAa;oBACf,OAAO,0VAAY,CAAC,IAAI,CACtB;wBAAE,OAAO;oBAA0C,GACnD;wBAAE,QAAQ;oBAAI;gBAElB;YACF,OAAO;gBACL,OAAO,0VAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAqB,GAAG;oBAAE,QAAQ;gBAAI;YAC1E;QACF;QAEA,MAAM,UAAU,eAAe,KAAK,OAAO,CAAC,OAAO;QACnD,MAAM,aAAa,GAAG,QAAQ,qBAAqB,CAAC;QAEpD,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,YAAY,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,iBAAiB;YAChF;YACA,MAAM;gBACJ,YAAY;gBACZ,gBAAgB;YAClB;QACF;QAEA,IAAI,OAAO;YACT,OAAO,0VAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,OAAO,0VAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAe;IACrD,EAAE,OAAO,OAAO;QACd,OAAO,0VAAY,CAAC,IAAI,CACtB;YAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAkB,GACpE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}